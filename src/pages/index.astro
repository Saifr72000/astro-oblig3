---
import Layout from '../layouts/Layout.astro';
import { fetchFilms } from '../lib/api';
import { getFilmPoster } from '../lib/images';
import type { Film } from '../lib/types';

// Fetch all films at build time
const films = await fetchFilms();
const sortedFilms = [...films].sort(
  (a, b) => parseInt(a.release_date) - parseInt(b.release_date)
);
---

<Layout title="Studio Ghibli Films Explorer">
	<!-- Soot Sprites (Susuwatari) - matching baseline exactly -->
	<div class="soot-sprites">
		<div class="soot-sprite" style="left: 10%; animation-delay: 0s; width: 28px; height: 28px;">
			<div class="soot-limbs"></div>
		</div>
		<div class="soot-sprite" style="left: 25%; animation-delay: 2s; width: 32px; height: 32px;">
			<div class="soot-limbs"></div>
		</div>
		<div class="soot-sprite" style="left: 45%; animation-delay: 4s; width: 26px; height: 26px;">
			<div class="soot-limbs"></div>
		</div>
		<div class="soot-sprite" style="left: 65%; animation-delay: 1s; width: 30px; height: 30px;">
			<div class="soot-limbs"></div>
		</div>
		<div class="soot-sprite" style="left: 80%; animation-delay: 3s; width: 34px; height: 34px;">
			<div class="soot-limbs"></div>
		</div>
		<div class="soot-sprite" style="left: 90%; animation-delay: 5s; width: 27px; height: 27px;">
			<div class="soot-limbs"></div>
		</div>
	</div>

	<!-- Kodama (Tree Spirits) - matching baseline exactly -->
	<div class="kodama-container">
		<div class="kodama" style="left: 15%; top: 20%;"></div>
		<div class="kodama" style="left: 75%; top: 35%;"></div>
		<div class="kodama" style="left: 30%; top: 60%;"></div>
	</div>

	<!-- Floating Leaves - matching baseline exactly -->
	<div class="leaves">
		<div class="leaf" style="left: 20%; animation-delay: 0s;"></div>
		<div class="leaf" style="left: 50%; animation-delay: 3s;"></div>
		<div class="leaf" style="left: 70%; animation-delay: 6s;"></div>
		<div class="leaf" style="left: 85%; animation-delay: 9s;"></div>
	</div>

	<header>
		<div class="container">
			<h1 class="logo">STUDIO GHIBLI</h1>
			<p class="tagline">Explore the Magical World of Ghibli</p>
		</div>
	</header>

	<main class="container">
		<div class="films-grid">
		{sortedFilms.map((film: Film) => {
			const posterSrc = getFilmPoster(film.id);
			return (
					<a href={`/film/${film.id}`} class="film-card">
						<div style="position: relative; width: 100%; height: 450px; overflow: hidden;">
							<img
								src={posterSrc}
								alt={film.title}
								width="400"
								height="450"
								loading="lazy"
								decoding="async"
								style="width: 100%; height: 100%; object-fit: cover; display: block;"
							/>
						</div>
						<div class="film-content">
							<div class="release-year">{film.release_date}</div>
							<h2>{film.title}</h2>
							<div class="original-title">{film.original_title}</div>
							<div class="film-info">
								<div class="info-item">
									<span class="info-label">Director:</span>
									<span>{film.director}</span>
								</div>
								<div class="info-item">
									<span class="info-label">Producer:</span>
									<span>{film.producer}</span>
								</div>
								<div class="info-item">
									<span class="info-label">Runtime:</span>
									<span>{film.running_time} mins</span>
								</div>
								<div class="info-item">
									<span class="rt-score">‚≠ê {film.rt_score}%</span>
								</div>
							</div>
							<div class="description">{film.description}</div>
						</div>
					</a>
				);
			})}
		</div>
	</main>
</Layout>
