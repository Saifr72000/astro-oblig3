---
import Layout from '../../layouts/Layout.astro';
import {
  fetchFilms,
  fetchSpecies,
  fetchPerson,
  fetchFilmByUrl,
  isValidResourceUrl,
  extractIdFromUrl,
} from '../../lib/api';
import type { Person, Film } from '../../lib/types';

// Generate all species pages at build time
export async function getStaticPaths() {
  const films = await fetchFilms();
  const speciesIds = new Set<string>();

  for (const film of films) {
    for (const speciesUrl of film.species) {
      if (isValidResourceUrl(speciesUrl)) {
        const id = extractIdFromUrl(speciesUrl);
        speciesIds.add(id);
      }
    }
  }

  return Array.from(speciesIds).map((id) => ({
    params: { id },
  }));
}

const { id } = Astro.params;
const species = await fetchSpecies(id!);

if (!species) {
  return Astro.redirect('/404');
}

// Fetch all people (characters) of this species
const validPeopleUrls = species.people.filter(isValidResourceUrl);
const peoplePromises = validPeopleUrls.map((url) => fetchPerson(url));
const people = await Promise.all(peoplePromises);
const validPeople = people.filter((p): p is Person => p !== null);

// Fetch all films featuring this species
const validFilmUrls = species.films.filter(isValidResourceUrl);
const filmsPromises = validFilmUrls.map((url) => fetchFilmByUrl(url));
const films = await Promise.all(filmsPromises);
const validFilms = films.filter((f): f is Film => f !== null);

// Helper functions
function getInitials(name: string): string {
  if (!name) return '?';
  const parts = name.split(' ');
  if (parts.length >= 2) {
    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
  }
  return name.substring(0, 2).toUpperCase();
}

function getAvatarColor(gender: string): string {
  if (!gender) return 'avatar-neutral';
  const genderLower = gender.toLowerCase();
  if (genderLower === 'female') return 'avatar-female';
  if (genderLower === 'male') return 'avatar-male';
  return 'avatar-neutral';
}

function capitalize(str: string): string {
  if (!str || str === 'n/a' || str === 'NA') return str;
  return str
    .split(' ')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

function getSpeciesHeroClass(classification: string): string {
  const lowerClass = classification.toLowerCase();
  if (lowerClass.includes('mammal')) return 'species-hero-mammal';
  if (lowerClass.includes('spirit')) return 'species-hero-spirit';
  if (lowerClass.includes('bird')) return 'species-hero-bird';
  return 'species-hero-default';
}
---

<Layout title={`${species.name} - Studio Ghibli Species`}>
	<header>
		<div class="container">
			<h1 class="logo">STUDIO GHIBLI</h1>
			<div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
				<a href="/" class="back-btn">
					‚Üê All Films
				</a>
			</div>
		</div>
	</header>

	<main class="container">
		<div class="species-detail">
			<!-- Species Hero -->
			<div class={`species-hero ${getSpeciesHeroClass(species.classification)}`}>
				<div class="species-hero-content">
					<h2 class="species-hero-title">{species.name}</h2>
					<div class="species-hero-subtitle">
						{species.classification}
					</div>
				</div>
			</div>

			<!-- Species Details -->
			<div class="detail-header">
				<h3 class="section-title">Species Information</h3>

				<div class="info-grid">
					<div class="info-box">
						<div class="info-box-label">Classification</div>
						<div class="info-box-value">{species.classification}</div>
					</div>
					{species.eye_colors && species.eye_colors !== 'n/a' && (
						<div class="info-box">
							<div class="info-box-label">Eye Colors</div>
							<div class="info-box-value">{capitalize(species.eye_colors)}</div>
						</div>
					)}
					{species.hair_colors && species.hair_colors !== 'n/a' && (
						<div class="info-box">
							<div class="info-box-label">Hair Colors</div>
							<div class="info-box-value">{capitalize(species.hair_colors)}</div>
						</div>
					)}
				</div>
			</div>

			<!-- Characters of this species -->
			<div class="characters-section">
				<h3 class="section-title">Characters ({validPeople.length})</h3>
				{validPeople.length === 0 ? (
					<p style="text-align: center; color: var(--text-dark);">
						No character information available for this species.
					</p>
				) : (
					<div class="characters-grid">
						{validPeople.map((person) => (
							<div class="character-card">
								<div class={`character-avatar ${getAvatarColor(person.gender)}`}>
									{getInitials(person.name)}
								</div>
								<h4>{person.name}</h4>
								<div class="character-details">
									{person.gender && (
										<div class="character-detail-item">
											<span class="detail-label">Gender:</span>
											<span class="detail-value">{capitalize(person.gender)}</span>
										</div>
									)}
									{person.age && (
										<div class="character-detail-item">
											<span class="detail-label">Age:</span>
											<span class="detail-value">{person.age}</span>
										</div>
									)}
									{person.eye_color && (
										<div class="character-detail-item">
											<span class="detail-label">Eye Color:</span>
											<span class="detail-value">{capitalize(person.eye_color)}</span>
										</div>
									)}
									{person.hair_color && (
										<div class="character-detail-item">
											<span class="detail-label">Hair Color:</span>
											<span class="detail-value">{capitalize(person.hair_color)}</span>
										</div>
									)}
								</div>
							</div>
						))}
					</div>
				)}
			</div>

			<!-- Films featuring this species -->
			<div class="additional-section">
				<h3 class="section-title">Films Featuring this Species</h3>
				{validFilms.length === 0 ? (
					<p style="text-align: center; color: var(--text-dark);">
						No film information available.
					</p>
				) : (
					<div class="info-list">
						{validFilms.map((film) => (
							<a
								href={`/film/${film.id}`}
								class="info-tag"
								style="cursor: pointer; text-decoration: none;"
							>
								{film.title}
							</a>
						))}
					</div>
				)}
			</div>
		</div>
	</main>
</Layout>

